<nav title-text="ä¹ é¢˜"></nav>

<!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
<view class="quiz-tabs">
  <view
    class="tab-item {{ activeTab === 'practice' ? 'active' : '' }}"
    bind:tap="switchTab"
    data-tab="practice"
  >
    ç»ƒä¹ é¢˜
  </view>
  <view
    class="tab-item {{ activeTab === 'wrong' ? 'active' : '' }}"
    bind:tap="switchTab"
    data-tab="wrong"
  >
    é”™é¢˜æœ¬
  </view>
</view>

<!-- ç»ƒä¹ é¢˜ç•Œé¢ -->
<scroll-view class="quiz-container" scroll-y wx:if="{{ activeTab === 'practice' }}">
  <view wx:if="{{ quizList.length === 0 }}" class="empty-state">
    <view class="empty-icon">ğŸ“</view>
    <text>æš‚æ— é¢˜ç›®ï¼Œåœ¨å¯¹è¯ä¸­ç‚¹å‡»"ç”Ÿæˆä¸€é“é¢˜"</text>
  </view>
  <view class="quiz-question" wx:for="{{ quizList }}" wx:key="index">
    <!-- é¢˜ç›®ä¿¡æ¯å¤´ -->
    <view class="question-header">
      <view class="question-number">ç¬¬ {{ index + 1 }} é¢˜</view>
      <view class="question-type">{{ item.difficulty }}</view>
    </view>

    <!-- é¢˜ç›®æ–‡æœ¬ -->
    <view class="question-text">{{ item.question }}</view>

    <!-- é€‰é¡¹ -->
    <view class="options-list">
      <view
        wx:for="{{ item.options }}"
        wx:for-item="option"
        wx:for-index="optionIndex"
        wx:key="optionIndex"
        class="option-item {{ item.userAnswer === optionIndex ? 'selected' : '' }} {{ item.submitted && item.userAnswer === optionIndex ? (item.userAnswer === item.correctAnswer ? 'correct' : 'incorrect') : '' }}"
        bind:tap="selectAnswer"
        data-question-index="{{ index }}"
        data-option-index="{{ optionIndex }}"
        data-disabled="{{ item.submitted }}"
      >
        <view class="option-label"></view>
        <text>{{ option }}</text>
      </view>
    </view>

    <!-- ç­”æ¡ˆå’Œè§£æ -->
    <view wx:if="{{ item.submitted }}" class="answer-section">
      <view class="answer-result {{ item.userAnswer === item.correctAnswer ? 'correct' : 'incorrect' }}">
        <view class="answer-text">
          <text>{{ item.userAnswer === item.correctAnswer ? 'âœ“ æ­£ç¡®' : 'âœ• ç­”é”™äº†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ' + (item.correctAnswerDisplay || 'A') }}</text>
        </view>
      </view>

      <!-- å±•å¼€è§£ææŒ‰é’® -->
      <view class="expand-section">
        <view
          class="expand-button"
          bind:tap="toggleAnalysis"
          data-question-index="{{ index }}"
        >
          <text>{{ item.showAnalysis ? 'æ”¶èµ·è§£æ' : 'å±•å¼€è§£æ' }}</text>
          <text class="expand-icon">{{ item.showAnalysis ? 'â–²' : 'â–¼' }}</text>
        </view>

        <!-- è§£æå†…å®¹ - æ”¯æŒ Markdown æ¸²æŸ“ -->
        <view wx:if="{{ item.showAnalysis }}" class="analysis-panel">
          <view class="analysis-title">è§£æ</view>
          <view class="analysis-content">
            <!-- ä¼˜å…ˆæ˜¾ç¤º Markdown æ¸²æŸ“çš„å†…å®¹ -->
            <decode wx:if="{{ item.explanationNodes }}" nodes="{{ item.explanationNodes }}" />
            <!-- å¦åˆ™æ˜¾ç¤ºçº¯æ–‡æœ¬ -->
            <text wx:else class="analysis-text">{{ item.explanation }}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view wx:if="{{ !item.submitted }}" class="button-group">
      <button
        class="submit-btn"
        bind:tap="submitAnswer"
        data-question-index="{{ index }}"
        disabled="{{ item.userAnswer === null }}"
      >
        æäº¤ç­”æ¡ˆ
      </button>
    </view>

    <!-- åˆ†éš”çº¿ -->
    <view class="divider"></view>
  </view>
</scroll-view>

<!-- é”™é¢˜æœ¬ç•Œé¢ -->
<scroll-view class="quiz-container wrong-questions" scroll-y wx:if="{{ activeTab === 'wrong' }}">
  <view wx:if="{{ wrongList.length === 0 }}" class="empty-state">
    <view class="empty-icon">ğŸ“š</view>
    <text>æš‚æ— é”™é¢˜</text>
  </view>
  <view class="quiz-question" wx:for="{{ wrongList }}" wx:key="index">
    <view class="question-header">
      <view class="question-number">é”™é¢˜ {{ index + 1 }}</view>
      <view class="question-type">{{ item.difficulty }}</view>
    </view>

    <view class="question-text">{{ item.question }}</view>

    <!-- é€‰é¡¹åˆ—è¡¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ -->
    <view wx:if="{{ item.options && item.options.length > 0 }}" class="options-list">
      <view
        wx:for="{{ item.options }}"
        wx:for-item="option"
        wx:for-index="optionIndex"
        wx:key="optionIndex"
        class="option-item {{ optionIndex === item.userAnswerIndex ? 'user-answer' : '' }} {{ optionIndex === item.correctAnswerIndex ? 'correct-answer-highlight' : '' }}"
      >
        <view class="option-label"></view>
        <text>{{ option }}</text>
      </view>
    </view>

    <!-- ç­”æ¡ˆè¯´æ˜ -->
    <view class="answer-section">
      <view class="answer-result incorrect">
        <view class="answer-text">
          <text wx:if="{{ item.userAnswerIndex !== null }}">âœ• ä½ çš„ç­”æ¡ˆï¼š{{ String.fromCharCode(65 + item.userAnswerIndex) }} | æ­£ç¡®ç­”æ¡ˆï¼š{{ item.correctAnswer }}</text>
          <text wx:else>âœ• æ­£ç¡®ç­”æ¡ˆï¼š{{ item.correctAnswer }}</text>
        </view>
      </view>

      <!-- å±•å¼€è§£ææŒ‰é’® -->
      <view class="expand-section">
        <view
          class="expand-button"
          bind:tap="toggleWrongAnalysis"
          data-question-index="{{ index }}"
        >
          <text>{{ item.showAnalysis ? 'æ”¶èµ·è§£æ' : 'å±•å¼€è§£æ' }}</text>
          <text class="expand-icon">{{ item.showAnalysis ? 'â–²' : 'â–¼' }}</text>
        </view>

        <!-- è§£æå†…å®¹ - æ”¯æŒ Markdown æ¸²æŸ“ -->
        <view wx:if="{{ item.showAnalysis }}" class="analysis-panel">
          <view class="analysis-title">è§£æ</view>
          <view class="analysis-content">
            <!-- ä¼˜å…ˆæ˜¾ç¤º Markdown æ¸²æŸ“çš„å†…å®¹ -->
            <decode wx:if="{{ item.explanationNodes }}" nodes="{{ item.explanationNodes }}" />
            <!-- å¦åˆ™æ˜¾ç¤ºçº¯æ–‡æœ¬ -->
            <text wx:else class="analysis-text">{{ item.explanation }}</text>
          </view>
        </view>
      </view>

      <!-- åˆ é™¤æŒ‰é’® -->
      <view class="button-group">
        <button
          class="delete-btn"
          bind:tap="deleteWrong"
          data-question-index="{{ index }}"
        >
          åˆ é™¤æ­¤é¢˜
        </button>
      </view>
    </view>

    <view class="divider"></view>
  </view>
</scroll-view>

<view class="generate-button" bind:tap="generateQuiz">
  <view class="button-plus"></view>
</view>