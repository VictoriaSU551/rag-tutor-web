<nav title-text="ä¹ é¢˜"></nav>

<!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
<view class="quiz-tabs">
  <view
    class="tab-item {{ activeTab === 'practice' ? 'active' : '' }}"
    bind:tap="switchTab"
    data-tab="practice"
  >
    ç»ƒä¹ é¢˜
  </view>
  <view
    class="tab-item {{ activeTab === 'wrong' ? 'active' : '' }}"
    bind:tap="switchTab"
    data-tab="wrong"
  >
    é”™é¢˜æœ¬
  </view>
</view>

<!-- ç»ƒä¹ é¢˜ç•Œé¢ -->
<scroll-view class="quiz-container" scroll-y wx:if="{{ activeTab === 'practice' }}">
  <view wx:if="{{ quizList.length === 0 }}" class="empty-state">
    <view class="empty-icon">ğŸ“</view>
    <text>æš‚æ— é¢˜ç›®ï¼Œåœ¨å¯¹è¯ä¸­ç‚¹å‡»"ç”Ÿæˆä¸€é“é¢˜"</text>
  </view>
  <view class="quiz-question" wx:for="{{ quizList }}" wx:key="index">
    <!-- é¢˜ç›®ä¿¡æ¯å¤´ -->
    <view class="question-header">
      <view class="question-number">ç¬¬ {{ index + 1 }} é¢˜</view>
      <view class="question-type">{{ item.type }}</view>
    </view>

    <!-- é¢˜ç›®æ–‡æœ¬ -->
    <view class="question-text">{{ item.question }}</view>

    <!-- é€‰é¡¹ -->
    <view class="options-list">
      <view
        wx:for="{{ item.options }}"
        wx:for-item="option"
        wx:for-index="optionIndex"
        wx:key="optionIndex"
        class="option-item {{ item.userAnswer === optionIndex ? 'selected' : '' }} {{ item.submitted && item.userAnswer === optionIndex ? (item.userAnswer === item.correctAnswer ? 'correct' : 'incorrect') : '' }}"
        bind:tap="selectAnswer"
        data-question-index="{{ index }}"
        data-option-index="{{ optionIndex }}"
      >
        <view class="option-label"></view>
        <text>{{ option }}</text>
      </view>
    </view>

    <!-- ç­”æ¡ˆå’Œè§£æ -->
    <view wx:if="{{ item.submitted }}" class="answer-section">
      <view class="answer-result {{ item.userAnswer === item.correctAnswer ? 'correct' : 'incorrect' }}">
        <view class="answer-text">
          <text>{{ item.userAnswer === item.correctAnswer ? 'âœ“ æ­£ç¡®' : 'âœ• ç­”é”™äº†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ' + (item.correctAnswerLabel || 'æœªçŸ¥') }}</text>
        </view>
      </view>

      <!-- åŠ å…¥é”™é¢˜æœ¬ -->
      <view wx:if="{{ item.userAnswer !== item.correctAnswer }}" class="action-group">
        <button
          class="add-wrong-btn"
          bind:tap="addWrong"
          data-question-index="{{ index }}"
          disabled="{{ item.addedToWrong }}"
        >
          {{ item.addedToWrong ? 'âœ… å·²åŠ å…¥é”™é¢˜æœ¬' : 'â• åŠ å…¥é”™é¢˜æœ¬' }}
        </button>
      </view>

      <!-- å±•å¼€è§£ææŒ‰é’® -->
      <view class="expand-section">
        <view
          class="expand-button"
          bind:tap="toggleAnalysis"
          data-question-index="{{ index }}"
        >
          <text>{{ item.showAnalysis ? 'æ”¶èµ·è§£æ' : 'å±•å¼€è§£æ' }}</text>
          <text class="expand-icon">{{ item.showAnalysis ? 'â–²' : 'â–¼' }}</text>
        </view>

        <!-- è§£æå†…å®¹ -->
        <view wx:if="{{ item.showAnalysis }}" class="analysis-panel">
          <view class="analysis-title">è§£æ</view>
          <decode wx:if="{{ item.analysisNodes }}" nodes="{{ item.analysisNodes }}" />
          <text wx:else class="analysis-text">{{ item.analysis }}</text>
        </view>
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view wx:if="{{ !item.submitted }}" class="button-group">
      <button
        class="submit-btn"
        bind:tap="submitAnswer"
        data-question-index="{{ index }}"
        disabled="{{ item.userAnswer === null }}"
      >
        æäº¤ç­”æ¡ˆ
      </button>
    </view>

    <!-- åˆ†éš”çº¿ -->
    <view class="divider"></view>
  </view>
</scroll-view>

<!-- é”™é¢˜æœ¬ç•Œé¢ -->
<scroll-view class="quiz-container wrong-questions" scroll-y wx:if="{{ activeTab === 'wrong' }}">
  <view wx:if="{{ wrongList.length === 0 }}" class="empty-state">
    <view class="empty-icon">ğŸ“š</view>
    <text>æš‚æ— é”™é¢˜</text>
  </view>
  <view class="quiz-question" wx:for="{{ wrongList }}" wx:key="index">
    <view class="question-header">
      <view class="question-number">é”™é¢˜ {{ index + 1 }}</view>
      <view class="question-type">{{ item.type }}</view>
    </view>

    <view class="question-text">{{ item.question }}</view>

    <view class="options-list">
      <view
        wx:for="{{ item.options }}"
        wx:for-item="option"
        wx:for-index="optionIndex"
        wx:key="optionIndex"
        class="option-item {{ optionIndex === item.userAnswer ? 'selected' : '' }} {{ item.submitted && item.userAnswer === optionIndex ? (item.isCorrect ? 'correct' : 'incorrect') : '' }}"
        bind:tap="selectWrongAnswer"
        data-question-index="{{ index }}"
        data-option-index="{{ optionIndex }}"
      >
        <view class="option-label"></view>
        <text>{{ option }}</text>
      </view>
    </view>

    <view wx:if="{{ item.submitted }}" class="answer-section">
      <view class="answer-result {{ item.isCorrect ? 'correct' : 'incorrect' }}">
        <view class="answer-text">
          <text>{{ item.isCorrect ? 'âœ“ æ­£ç¡®' : 'âœ• ç­”é”™äº†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ' + (item.correctAnswerLabel || 'æœªçŸ¥') }}</text>
        </view>
      </view>

      <view class="action-group">
        <button
          class="delete-wrong-btn"
          bind:tap="deleteWrong"
          data-question-index="{{ index }}"
        >
          ğŸ—‘ åˆ é™¤é”™é¢˜
        </button>
      </view>

      <view class="expand-section">
        <view
          class="expand-button"
          bind:tap="toggleWrongAnalysis"
          data-question-index="{{ index }}"
        >
          <text>{{ item.showAnalysis ? 'æ”¶èµ·è§£æ' : 'å±•å¼€è§£æ' }}</text>
          <text class="expand-icon">{{ item.showAnalysis ? 'â–²' : 'â–¼' }}</text>
        </view>

        <view wx:if="{{ item.showAnalysis }}" class="analysis-panel">
          <view class="analysis-title">è§£æ</view>
          <decode wx:if="{{ item.analysisNodes }}" nodes="{{ item.analysisNodes }}" />
          <text wx:else class="analysis-text">{{ item.analysis }}</text>
        </view>
      </view>
    </view>

    <view class="button-group">
      <button
        class="submit-btn"
        bind:tap="submitWrongAnswer"
        data-question-index="{{ index }}"
        disabled="{{ item.userAnswer === null || item.userAnswer === undefined }}"
      >
        æäº¤ç­”æ¡ˆ
      </button>
    </view>

    <view class="divider"></view>
  </view>
</scroll-view>

<view class="bottom-safe" />