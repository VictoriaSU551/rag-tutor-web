<wxs src="./index.wxs" module="utils" />

<t-navbar class="nav-bar" title="{{ name }}" left-arrow />

<view class="chat-container">
  <scroll-view class="content" scroll-y scroll-into-view="{{ anchor }}">
    <view class="messages">
      <block wx:for="{{ messages }}" wx:key="index">
        <view wx:if="{{ item.from === 0 }}" class="message-item self-message">
          <view class="message-header">
            <view class="speaker-label self-label">ä½ </view>
            <view class="message-timestamp">{{ utils.formatTime(item.time) }}</view>
          </view>
          <view class="message-container">
            <view class="message-tag self-tag"></view>
            <view class="message self">
              <text space="nbsp">{{ item.content }}</text>
              <t-loading
                wx:if="{{ item.messageId === null }}"
                t-class="loading"
                theme="spinner"
                size="32rpx"
                class="wrapper"
              />
            </view>
          </view>
        </view>

        <view wx:else class="message-item other-message">
          <view class="message-header">
            <view class="speaker-label other-label">åŠ©æ‰‹</view>
            <view class="message-timestamp">{{ utils.formatTime(item.time) }}</view>
          </view>
          <view class="message-container">
            <view class="message-tag other-tag"></view>
            <view class="message other">
              <!-- ä¼˜å…ˆæ˜¾ç¤ºæ¸²æŸ“çš„ markdownï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤ºçº¯æ–‡æœ¬ï¼ˆæµå¼è¾“å‡ºï¼‰ -->
              <decode wx:if="{{ item.contentNodes }}" nodes="{{ item.contentNodes }}" />
              <text wx:else class="streaming-text">{{ item.content }}</text>
              
              <!-- çŸ¥è¯†æ¥æºï¼ˆä¸å›ç­”æ— ç¼æ‹¼æ¥ï¼‰ -->
              <view wx:if="{{ item.sources && item.sources.length > 0 }}" class="message-sources">
                <view class="sources-title">ğŸ“š çŸ¥è¯†æ¥æºï¼š</view>
                <view class="source-list">
                  <view class="source-item" wx:for="{{ item.sources }}" wx:for-item="source" wx:key="index">
                    <text class="source-text">{{ source.displayBook }} - ç¬¬{{ source.page }}é¡µ</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
          <!-- ç”Ÿæˆä¸€é“é¢˜æŒ‰é’® -->
          <view wx:if="{{ item.userMsgIndex !== null && item.userMsgIndex !== undefined }}" class="gen-exercise-wrap">
            <button 
              wx:if="{{ !utils.includes(exercisedIndices, item.userMsgIndex) }}" 
              class="gen-exercise-btn" 
              data-msg-index="{{ item.userMsgIndex }}" 
              bind:tap="handleGenerateExercise"
              disabled="{{ generatingExercise }}"
            >
              {{ generatingExercise ? 'â˜£ é¢˜ç›®ç”Ÿæˆä¸­...' : 'ğŸ“ ç”Ÿæˆä¸€é“é¢˜' }}
            </button>
            <view wx:else class="gen-exercise-done">âœ… å·²ç”Ÿæˆé¢˜ç›®</view>
          </view>
        </view>
      </block>
      <view id="bottom" />
    </view>
  </scroll-view>
</view>

<view class="block" style="margin-bottom: {{ keyboardHeight }}px" />
<view class="bottom" style="margin-bottom: {{ keyboardHeight }}px">
  <view class="input">
    <input
      value="{{ input }}"
      type="text"
      confirm-type="send"
      placeholder="è¯·è¾“å…¥"
      placeholder-style="color: #00000066"
      adjust-position="{{ false }}"
      hold-keyboard
      confirm-hold
      bindkeyboardheightchange="handleKeyboardHeightChange"
      bindblur="handleBlur"
      bindinput="handleInput"
      bindconfirm="sendMessage"
    />
  </view>
  <view class="send-btn" bind:tap="sendMessage" disabled="{{ !input || generatingExercise }}">
    <image src="/static/icon/send.svg" class="send-icon" />
  </view>
</view>
