<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <title>知识库管理</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-center">知识库管理</h1>

      <!-- 上传新PDF -->
      <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4">上传新PDF</h2>
        <form id="uploadForm" enctype="multipart/form-data" class="space-y-4">
          <div>
            <label for="pdfFile" class="block text-sm font-medium text-gray-700">选择PDF文件</label>
            <input type="file" id="pdfFile" name="file" accept="application/pdf" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-500 focus:border-orange-500" required />
          </div>
          <button type="submit" class="bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2">上传PDF</button>
        </form>
        <div id="uploadMessage" class="mt-4"></div>
      </div>

      <!-- 现有PDF列表 -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">现有PDF文件</h2>
        <div id="pdfList" class="space-y-2">
          <!-- PDF列表将在这里动态加载 -->
        </div>
      </div>
    </div>
  </div>

  <script>
    const uploadForm = document.getElementById('uploadForm');
    const uploadMessage = document.getElementById('uploadMessage');
    const pdfList = document.getElementById('pdfList');

    // 加载现有PDF列表
    async function loadPdfList() {
      const token = localStorage.getItem('token');
      if (!token) {
        pdfList.innerHTML = '<p class="text-gray-500">请先登录</p>';
        return;
      }

      try {
        const response = await fetch('/api/pdfs', {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const pdfs = await response.json();
          displayPdfs(pdfs);
        } else {
          pdfList.innerHTML = '<p class="text-red-500">加载PDF列表失败</p>';
        }
      } catch (error) {
        pdfList.innerHTML = '<p class="text-red-500">网络错误</p>';
      }
    }

    // 显示PDF列表
    function displayPdfs(pdfs) {
      if (pdfs.length === 0) {
        pdfList.innerHTML = '<p class="text-gray-500">暂无PDF文件</p>';
        return;
      }

      pdfList.innerHTML = pdfs.map(pdf => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
          <div class="flex-1">
            <p class="font-medium">${pdf.name}</p>
            <p class="text-sm text-gray-500">上传时间: ${new Date(pdf.upload_time).toLocaleString()}</p>
          </div>
          <button onclick="deletePdf('${pdf.name}')" class="text-red-500 hover:text-red-700 ml-4">删除</button>
        </div>
      `).join('');
    }

    // 删除PDF
    async function deletePdf(filename) {
      if (!confirm(`确定要删除 ${filename} 吗？`)) return;

      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`/api/pdfs/${encodeURIComponent(filename)}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          loadPdfList(); // 重新加载列表
        } else {
          alert('删除失败');
        }
      } catch (error) {
        alert('网络错误');
      }
    }

    // 上传PDF
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(uploadForm);
      const token = localStorage.getItem('token');
      if (!token) {
        uploadMessage.textContent = '请先登录';
        uploadMessage.className = 'mt-4 text-red-500';
        return;
      }

      uploadMessage.textContent = '上传中...';
      uploadMessage.className = 'mt-4 text-blue-500';

      try {
        formData.append('token', token);
        const response = await fetch('/api/upload-pdf', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          uploadMessage.textContent = result.message;
          uploadMessage.className = 'mt-4 text-green-500';
          uploadForm.reset();
          loadPdfList(); // 重新加载列表
        } else {
          const error = await response.json();
          uploadMessage.textContent = error.detail || '上传失败';
          uploadMessage.className = 'mt-4 text-red-500';
        }
      } catch (error) {
        uploadMessage.textContent = '网络错误';
        uploadMessage.className = 'mt-4 text-red-500';
      }
    });

    // 页面加载时获取PDF列表
    loadPdfList();
  </script>
</body>
</html>